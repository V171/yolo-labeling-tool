# YOLO Labeling Tool

[![English](https://img.shields.io/badge/English-007BFF?style=for-the-badge&logo=google-chrome)](README.md)
[![Русский](https://img.shields.io/badge/%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9-2E7D32?style=for-the-badge&logo=google-chrome)](README-ru.md)
[![Français](https://img.shields.io/badge/Fran%C3%A7ais-0055A4?style=for-the-badge&logo=google-chrome)](README-fr.md)
[![Deutsch](https://img.shields.io/badge/Deutsch-000000?style=for-the-badge&logo=google-chrome)](README-de.md)
[![日本語](https://img.shields.io/badge/%E6%97%A5%E6%9C%AC%E8%AA%9E-BC002D?style=for-the-badge&logo=google-chrome)](README-ja.md)
[![中文](https://img.shields.io/badge/%E4%B8%AD%E6%96%87-007A33?style=for-the-badge&logo=google-chrome)](README-zh.md)

YOLO形式の画像アノテーションを支援する、ニューラルネットワークによる自動ラベリングに対応した強力なツールです。

## 概要

このアプリケーションは、以下の完全なアノテーションワークフローを提供します：
- 事前学習済みYOLOモデル（detect/OBB/segment）によるボックスおよびポリゴンの自動生成
- アノテーションの手動編集（追加・削除・移動・リサイズ）
- グラウンドトゥルースデータとのリアルタイム評価
- プロジェクト管理とトレーニング用データセットへのエクスポート

**主な機能：**
- ✅ 2つのアノテーションモード：ボックスモード と ポリゴンモード
- ✅ モデルベースの自動ラベリング（YOLO detect/OBB/segment）
- ✅ IoUベースの評価モードでFP/FNを可視化
- ✅ クラスごとの色分けとカスタムクラスマネージャー
- ✅ キーボード操作とショートカットキーの完全対応
- ✅ UI言語の設定可能（多言語対応）

> 💡 **ヒント**：`H` でアノテーションの表示/非表示を切り替え、`N` でトレーニング用に保存、`E` で評価モードを有効化してください。

---

## クイックスタート

### 必要環境
- Python 3.8+
- Windows / Linux / macOS

### インストール
```bash
git clone https://github.com/V171/yolo-labeling-tool.git
cd yolo-labeling-tool
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install ultralytics opencv-python pyqt5 numpy
```

### 設定
`config.json` を編集してください：
```json
{
  "model_path": "yolov8n.pt",
  "images_dir": "images",
  "train_dir": "TrainDataset",
  "language": "ja",
  "annotation_mode": "box",
  "iou_threshold": 0.5
}
```
- `model_path`: 使用するYOLOモデルファイル（.pt）のパス。
- `images_dir`: アノテーション対象の元画像が格納されたディレクトリ。
- `train_dir`: アノテーション済み画像をグランドトゥルースとして保存するディレクトリ（任意の場所に設定可能）。
- `language`: UI言語（`en`, `ru`, `fr`, `de`, `ja`, `zh`）。デフォルトは `en`。
- `annotation_mode`: デフォルトモード（`box` または `poly`）。
- `iou_threshold`: 評価時のマッチングに必要な最小IoU値。

> 📌 `images_dir` と `train_dir` は**外部ディレクトリ**であり、ツールのフォルダ外でも構いません。好きな場所に指定できます。

### 実行
```bash
python labeler.py
```

> ⚠️ **パフォーマンス注意**：起動後の最初の推論はモデルの読み込みのため遅くなることがあります。大規模な画像フォルダの場合、サブフォルダに分割して画像切り替え時間を短縮することをお勧めします。

---

## ナビゲーション

| 機能 | 説明 |
|--------|----------|
| **画像リスト** | メニューから開く：`表示 > 画像リストの表示/非表示`。項目をクリックするとその画像にジャンプします。背景色は状態を示します：白（未処理）、黄色（アノテーション済み）、緑（Trainに保存済み）。 |
| **クラスリスト** | メニューから開く：`表示 > クラスの表示/非表示`。クラスをクリックすると、選択中のアノテーションに割り当てられます。 |
| **評価サマリー** | メニューから開く：`表示 > 評価サマリーの表示/非表示`。現在の画像の統計情報を表示します。 |

---

## アノテーションモード

| モード | ショートカット | 説明 |
|------|----------|-------------|
| **ボックスモード** | `B` | 矩形のバウンディングボックスを描画します |
| **ポリゴンモード** | `P` | 頂点を制御しながら自由なポリゴンを描画します |

> 📌 **ポリゴンモード**では、少なくとも2点を配置した後、右クリックで描画を終了してください。

---

## ショートカットキー

| キー | アクション |
|-----|--------|
| `←` / `→` | 前の画像 / 次の画像 |
| `Z` | ランダム画像 |
| `N` | 現在の画像とアノテーションをTrainディレクトリに保存（信頼度スコアを削除） |
| `R` | 現在のアノテーションをリセット（現在の画像にモデルを再実行） |
| `H` | アノテーションの表示/非表示を切り替え |
| `V` | ビューをリセット（中央にズーム1倍） |
| `スペース` | アノテーションを一時的に非表示 |
| `Delete` | 選択中のアノテーションを削除 |
| `0-9` | 選択中のボックスのクラスID（0–9）を設定 |
| `Ctrl+←/→/↑/↓` | 選択中のボックスのサイズを微調整 |
| `E` | 評価モードの切り替え |
| `C` | クラス名の表示を切り替え（ID vs 名称） |
| `B` | ボックスモードに切り替え |
| `P` | ポリゴンモードに切り替え |

> 🔍 **注記**：`N` はアノテーションを `train_dir` に保存し、**信頼度スコアを削除**します。これによりトレーニングに適した形式になります。アノテーションは設定された閾値に基づいてツール内に引き続き表示されます。

---

## ファイル形式

### YOLO ボックス形式
各 `.txt` ファイルは対応する画像名と同じです：
```
<class_id> <x_center> <y_center> <width> <height> [<score>]
```

### ポリゴン（OBBおよびセグメンテーション用）
ポリゴンアノテーションの形式：
```
<class_id> <x1> <y1> <x2> <y2> ... <xn> <yn> [<score>]
```

- 座標は画像の幅と高さに対して `[0,1]` に正規化されています
- **信頼度スコアは `train_dir` に保存される際には省略**されます（グランドトゥルース形式）

---

## 評価モード

有効化時（`E` キー）：
- 現在のアノテーションと `train_dir` 内のグランドトゥルースを比較します
- 以下をハイライト表示：
  - 🔴 **偽陽性 (FP)**：検出されたがGTに存在しない
  - 🔵 **偽陰性 (FN)**：GTに存在するが検出されなかった
- **真陽性 (TP) は可視化されません** — 正しいと仮定されます。
- **エラーリスト**を開くには：
  1. 「評価サマリー」パネルへ移動します（`表示 > 評価サマリーの表示/非表示`）。
  2. **特定のクラスの FP または FN 列のセルをダブルクリック**します。
  3. 「エラーリスト」ドッキングウィンドウが開き、該当タイプとクラスのエラーのみが表示されます。
- エラーに移動するには：
  - 「エラーリスト」内のアイテムを**ダブルクリック**します。対応する画像が読み込まれます。

> 📊 **エラーリストの動作**：
> - 選択された行の**クラス**のエラーのみ表示されます。
> - クリックした**タイプ（FP/FN）** のエラーのみ表示されます。
> - 行をダブルクリックすると、対応する画像がビューアに読み込まれます。

---

## クラス管理

**表示 > クラスの表示/非表示** でクラスリストを開きます。
クラスをクリックすると、選択中のアノテーションに割り当てられます。

クラスを管理するには：
- **メニュー > アクション > クラスを管理...**
- クラスの追加・名前の変更・削除・モデルからのリセットが可能です
- クラスごとにカスタムカラーを割り当てられます

---

## プロジェクト構成

```
your-project/
├── config.json
├── labeler.py
├── images/                 # あなたの元画像（config.json で設定）
│   ├── img1.jpg
│   ├── img1.txt            # 自動生成または手動アノテーション
│   └── ...
├── TrainDataset/           # エクスポートされたトレーニングデータ（config.json で設定）
│   ├── img1.jpg
│   └── img1.txt
└── README.md               # このファイル
```

> 📌 アノテーションは `images_dir` に保存されます。`N` を使用して画像＋アノテーションを `train_dir` にコピーし、信頼度スコアを削除してください。

---

## エラーハンドリング

| 問題 | 解決策 |
|-------|----------|
| モデルが読み込まれない | `config.json` の `model_path` を確認し、`.pt` ファイルが存在するか確認してください |
| 最初の推論が遅い | 正常です — モデルは初回使用時に読み込まれます |
| アノテーションが表示されない | `H` キーで表示を切り替えてください。閾値スライダーを確認してください |
| クラス名が正しくない | モデルを再読み込みするか、クラスマネージャーで「モデルからリセット」を使用してください |
| エラーリストが開かない | 評価サマリーの **FP** または **FN** セルをダブルクリックしてください — **行ヘッダーではありません** |
| 画像が読み込まれない | `config.json` の `images_dir` が正しいか、有効な画像ファイルが含まれているか確認してください |

---

## 謝辞

- [Ultralytics](https://github.com/ultralytics/ultralytics) による YOLO
- [OpenCV](https://opencv.org/) によるコンピュータビジョン
- [PyQt5](https://pypi.org/project/PyQt5/) によるGUIフレームワーク
- [Qwen](https://chat.qwen.ai/) によるAI支援開発

© 2025 MIT ライセンス
